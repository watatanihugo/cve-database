import mysql.connector
from mysql.connector import Error
from tabulate import tabulate
from sqlconnec import connect


def create_base_score_view():
    conn = connect()
    cursor = conn.cursor()
    try:
        cursor.execute("""
            CREATE OR REPLACE VIEW base_score_view AS
            SELECT c.ID, c.Name, s.Base_Score, s.Attack_Vector_v3, LEFT(d.text_description, 255) AS truncated_description
            FROM CVE_ID c 
            JOIN CVE_Scores s ON c.ID = s.ID 
            JOIN Description d ON c.ID = d.ID
        """)
        print("Base score view created successfully.")
    except Error as e:
        print("Error creating base score view:", e)
    finally:
        if conn.is_connected():
            cursor.close()
            conn.close()
            print("Connection closed.")
            
def option_1():
    print("You chose Option 1")

    base_score = float(input("Enter exact base score to search for: "))

    conn = connect()
    cursor = conn.cursor()
    try:
        create_base_score_view()
        cursor.execute("""
            SELECT *
            FROM base_score_view
            WHERE Base_Score = '%s'
        """, (base_score,))
        result = cursor.fetchall()

        if result:
            headers = ["CVE_ID", "Name", "Base_Score", "Attack_Vector_v3", "Description"]
            print(tabulate(result, headers=headers, tablefmt="psql"))
        else:
            print("No matching entries found.")

    except Error as e:
        # TODO: Better error handling
        print("Error:", e)
    finally:
        if conn.is_connected():
            cursor.close()
            conn.close()
            print("Connection closed.")

def option_2():
    print("You chose Option 2")

    lowest_score = float(input("Enter the lowest base score to search for: "))

    conn = connect()
    cursor = conn.cursor()
    try:
        create_base_score_view()
        cursor.execute("""
            SELECT *
            FROM base_score_view
            WHERE Base_Score > '%s'
        """, (lowest_score,))
        result = cursor.fetchall()

        if result:
            headers = ["CVE_ID", "Name", "Base_Score", "Attack_Vector_v3", "Description"]
            print(tabulate(result, headers=headers, tablefmt="psql"))
        else:
            print("No matching entries found.")

    except Error as e:
        # TODO: Better error handling
        print("Error:", e)
    finally:
        if conn.is_connected():
            cursor.close()
            conn.close()
            print("Connection closed.")

def return_to_menu():
    print("Returning to Menu...")
    return True


def display_menu():
    print("Choose your search option")
    print("1. Find CVEs exact score")
    print("2. Find CVEs above certain score")
    print("0. Exit")


def searchscores_menu():
    menu_options = {
        "1": option_1,
        "2": option_2,
        "0": return_to_menu,
    }

    while True:
        display_menu()
        choice = input("Enter your choice (1 or 0 to exit): ")

        if choice in menu_options:
            should_exit = menu_options[choice]()
            if should_exit:
                break
        else:
            print("Invalid choice. Please choose a number from 0 to 1.")
